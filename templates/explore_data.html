<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Reporting System - Explore Data</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/shared-styles.css') }}">
    <style>
        .create-tables-btn {
            background-color: #5cb85c;
            color: white;
            border: none;
            padding: 10px 20px;
            margin-top: 0px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        .form-group {
            display: flex;
            justify-content: start;
            align-items: center;
            gap: 10px;
        }

        .form-control {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            height: 20px;
        }

        .overflow-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            border: 1px solid #ddd;
            text-align: left;
            padding: 8px;
        }

        th {
            background-color: #f2f2f2;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        table, th, td {
            font-size: 0.9em;
        }

        .results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .export-btn {
            background-color: #f8f9fa;
            border: 1px solid #ced4da;
            color: #212529;
            padding: 5px 10px;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            margin-left: 10px;
        }

        .export-btn:hover {
            background-color: #e9ecef;
        }

        .export-btn svg {
            margin-right: 5px;
        }

        #queryHistory, #queryTemplates {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: Arial, sans-serif;
        }

        .query-history-header, .query-templates-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        #queryHistory h3, #queryTemplates h3 {
            margin: 0;
            font-size: 14px;
            line-height: 1;
        }

        .clear-history-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            height: 16px;
        }

        .clear-history-btn svg {
            width: 16px;
            height: 16px;
            fill: #666;
            transition: fill 0.3s ease;
            display: block;
        }

        .clear-history-btn:hover svg {
            fill: #dc3545;
        }

        .query-history-header > *, .query-templates-header > * {
            display: flex;
            align-items: center;
        }

        #templateList, #historyList {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .history-item, .template-item {
            cursor: pointer;
            padding: 8px 5px;
            border: 1px solid #eee;
            border-radius: 4px;
            font-size: 12px;
            line-height: 1.4;
            transition: background-color 0.3s ease;
        }

        .history-item:hover, .template-item:hover {
            background-color: #f5f5f5;
        }

        .instructions {
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
            color: #666;
        }

        #queryDetails {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background-color: #f8f9fa;
        }

        #queryDetails h3 {
            margin-top: 0;
            font-size: 16px;
            margin-bottom: 10px;
        }

        #queryDetails pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-x: auto;
            background-color: #fff;
            border: 1px solid #e1e4e8;
            border-radius: 3px;
            padding: 10px;
            font-size: 14px;
            line-height: 1.45;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <header>
        <h1>Sales Reporting System</h1>
    </header>
    <nav>
        <ul>
            <li><a href="/">Files</a></li>
            <li><a href="/tables">Tables</a></li>
            <li><a href="/stored_procedures">Stored Procedures</a></li>
            <li><a href="/table_data">Table Data</a></li>
            <li><a href="/visualizations">Visualizations</a></li>
            <li><a href="/explore_data">QuickQueryAI</a></li>
        </ul>
    </nav>
    <div class="container">
        <h2>QuickQueryAI</h2>
        <div class="section">
            <div class="section-header">Natural Language Query</div>
            <p>
                Enter your question about the sales data in the input field below, or choose one of the query templates as an example. 
                Our AI will convert your natural language query into SQL and fetch the results for you.
            </p>
            <div id="queryTemplates">
                <h3>Query Templates</h3>
                <div id="templateList"></div>
            </div>
            <br>
            <div class="form-group">
                <input type="text" id="queryInput" class="form-control" placeholder="Enter your query here...">
                <button type="button" id="submitQueryBtn" class="create-tables-btn">Submit</button>
            </div>
            <div id="queryDetails" style="display: none;">
                <h3>SQL Query Generated</h3>
                <pre><code id="sqlQueryCode"></code></pre>
            </div>
            <div id="queryResultsContainer">
                <!-- Query results and export buttons will be displayed here -->
            </div>
            <div id="queryHistory">
                <div class="query-history-header">
                    <h3>Query History</h3>
                    <button id="clearHistoryBtn" class="clear-history-btn" title="Clear History">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M3 6v18h18v-18h-18zm5 14c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm5 0c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm5 0c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm4-18v2h-20v-2h5.711c.9 0 1.631-1.099 1.631-2h5.315c0 .901.73 2 1.631 2h5.712z"/>
                        </svg>
                    </button>
                </div>
                <div id="historyList"></div>
            </div>
        </div>
    </div>
    
    <script>
        let queryHistory = [];

        document.getElementById('submitQueryBtn').addEventListener('click', function() {
            const query = document.getElementById('queryInput').value;
            if (query) {
                submitQuery(query);
            } else {
                alert('Please enter a query first.');
            }
        });

        function submitQuery(query) {
            fetch(`/submit-query`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query: query })
            })
            .then(response => response.json())
            .then(data => {
                const queryDetailsDiv = document.getElementById('queryDetails');
                const sqlQueryCode = document.getElementById('sqlQueryCode');
                const queryResultsContainer = document.getElementById('queryResultsContainer');
                
                // Display the SQL query
                sqlQueryCode.textContent = data.sql_query;
                queryDetailsDiv.style.display = 'block';
                
                if (data.results && data.results.length > 0) {
                    queryResultsContainer.innerHTML = `
                        <div class="results-header">
                            <h3>Query Results</h3>
                            <div>
                                <button type="button" onclick="exportResults('csv')" class="export-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                    CSV
                                </button>
                                <button type="button" onclick="exportResults('excel')" class="export-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                    Excel
                                </button>
                            </div>
                        </div>
                    `;

                    const overflowContainer = document.createElement('div');
                    overflowContainer.className = 'overflow-container';

                    const table = document.createElement('table');
                    const thead = document.createElement('thead');
                    const headerRow = document.createElement('tr');
                    Object.keys(data.results[0]).forEach(key => {
                        const th = document.createElement('th');
                        th.textContent = key;
                        headerRow.appendChild(th);
                    });
                    thead.appendChild(headerRow);
                    table.appendChild(thead);

                    const tbody = document.createElement('tbody');
                    data.results.forEach(row => {
                        const tr = document.createElement('tr');
                        Object.values(row).forEach(value => {
                            const td = document.createElement('td');
                            td.textContent = value;
                            tr.appendChild(td);
                        });
                        tbody.appendChild(tr);
                    });
                    table.appendChild(tbody);

                    overflowContainer.appendChild(table);
                    queryResultsContainer.appendChild(overflowContainer);
                } else {
                    queryResultsContainer.innerHTML = '<p>No results found.</p>';
                }

                addToHistory(query);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function exportResults(format) {
            const queryResults = Array.from(document.querySelectorAll('#queryResultsContainer table tr')).map(row => {
                return Array.from(row.cells).reduce((acc, cell, index) => {
                    acc[document.querySelector('#queryResultsContainer table thead th:nth-child(' + (index + 1) + ')').textContent] = cell.textContent;
                    return acc;
                }, {});
            }).slice(1);
            
            fetch(`/export-query-results`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ data: queryResults, format: format })
            })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = format === 'csv' ? 'query_results.csv' : 'query_results.xlsx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function addToHistory(query) {
            queryHistory.unshift(query);
            if (queryHistory.length > 10) {
                queryHistory.pop();
            }
            updateHistoryDisplay();

            fetch('/save-query-history', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ history: queryHistory })
            });
        }

        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            queryHistory.forEach((query, index) => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.textContent = `${index + 1}. ${query.substring(0, 60)}${query.length > 60 ? '...' : ''}`;
                item.onclick = () => {
                    document.getElementById('queryInput').value = query;
                };
                historyList.appendChild(item);
            });
        }

        function clearHistory() {
            queryHistory = [];
            updateHistoryDisplay();
            
        fetch('/clear-query-history', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
        }

        document.getElementById('clearHistoryBtn').addEventListener('click', clearHistory);

        fetch('/get-query-history')
            .then(response => response.json())
            .then(data => {
                queryHistory = data.history;
                updateHistoryDisplay();
            });

        const queryTemplates = [
            { name: "Total Sales by Product", query: "What is the total sales amount for each product?" },
            { name: "Top 5 Customers", query: "Who are the top 5 customers by total purchase amount?" },
            { name: "Monthly Sales Trend", query: "Show the total sales amount for each month" },
            { name: "Employee Performance", query: "Which employees have the highest total sales?" },
            { name: "Popular Payment Methods", query: "What are the most commonly used payment methods?" }
        ];

        function populateQueryTemplates() {
            const templateList = document.getElementById('templateList');
            templateList.innerHTML = '';
            queryTemplates.forEach(template => {
                const item = document.createElement('div');
                item.className = 'template-item';
                item.textContent = template.name;
                item.onclick = () => {
                    document.getElementById('queryInput').value = template.query;
                };
                templateList.appendChild(item);
            });
        }

        populateQueryTemplates();

    </script>
</body>
</html>