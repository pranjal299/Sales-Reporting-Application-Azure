<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Reporting System - Explore Data</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/shared-styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .create-tables-btn {
            background-color: #5cb85c;
            color: white;
            border: none;
            padding: 10px 20px;
            margin-top: 0px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        .form-group {
            display: flex;
            justify-content: start;
            align-items: center;
            gap: 10px;
        }

        .form-control {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            height: 20px;
        }

        .overflow-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            border: 1px solid #ddd;
            text-align: left;
            padding: 8px;
        }

        th {
            background-color: #f2f2f2;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        table, th, td {
            font-size: 0.9em;
        }

        .results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .export-buttons {
    display: flex;
    gap: 10px;
}

        .export-btn {
            background-color: #f8f9fa;
            border: 1px solid #ced4da;
            color: #212529;
            padding: 5px 10px;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
        }

        .export-btn:hover {
            background-color: #e9ecef;
        }

        .export-btn svg {
            margin-right: 5px;
            vertical-align: middle;
        }

        #queryHistory, #queryTemplates {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: Arial, sans-serif;
        }

        .query-history-header, .query-templates-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        #queryHistory h3, #queryTemplates h3 {
            margin: 0;
            font-size: 14px;
            line-height: 1;
        }

        .clear-history-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
        }

        .clear-history-btn svg {
            width: 16px;
            height: 16px;
            fill: #666;
            transition: fill 0.3s ease;
        }

        .clear-history-btn:hover svg {
            fill: #dc3545;
        }

        .query-history-header > *, .query-templates-header > * {
            display: flex;
            align-items: center;
        }

        #templateList, #historyList {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .history-item, .template-item {
            cursor: pointer;
            padding: 8px 5px;
            border: 1px solid #eee;
            border-radius: 4px;
            font-size: 12px;
            line-height: 1.4;
            transition: background-color 0.3s ease;
        }

        .history-item:hover, .template-item:hover {
            background-color: #f5f5f5;
        }

        .instructions {
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
            color: #666;
        }

        #queryDetails {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background-color: #f8f9fa;
        }

        #queryDetails h3 {
            margin-top: 0;
            font-size: 16px;
            margin-bottom: 10px;
        }

        #queryDetails pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-x: auto;
            background-color: #fff;
            border: 1px solid #e1e4e8;
            border-radius: 3px;
            padding: 8px;
            font-size: 12px;
            line-height: 1.4;
            max-height: 250px;
            overflow-y: auto;
            display: none;
        }

        #historyList {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 10px;
        }

        #historyList::-webkit-scrollbar {
            width: 8px;
        }

        #historyList::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        #historyList::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        #historyList::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .pagination button {
            background-color: #f8f9fa;
            border: 1px solid #ced4da;
            color: #212529;
            padding: 3px 8px;
            margin: 0 3px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 0.9em;
        }

        .pagination button:hover {
            background-color: #e9ecef;
        }

        #pageInfo {
            margin: 0 8px;
            font-size: 0.9em;
        }

        .form-group {
            position: relative;
            display: flex;
            align-items: center;
            max-width: 600px;
            margin: 0 auto;
        }

        .form-control {
            flex: 1;
            padding: 10px 40px 10px 15px;
            border: 2px solid #ccc;
            border-radius: 25px;
            font-size: 16px;
            height: 20px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #5cb85c;
        }

        .submit-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .submit-icon:hover {
            color: #5cb85c;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            border-top-color: #5cb85c;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #queryDetails {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f8f9fa;
        }

        .collapsible-header {
            padding: 10px;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            user-select: none;
            display: flex;
            align-items: center;
        }

        .collapsible-header:not(.loading)::before {
            content: '▶ ';
            font-size: 12px;
            margin-right: 5px;
        }

        .collapsible-header.active:not(.loading)::before {
            content: '▼ ';
        }

        .collapsible-header.loading {
            padding-left: 10px;
        }

        #queryDetails pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-x: auto;
            background-color: #fff;
            border: 1px solid #e1e4e8;
            border-radius: 3px;
            padding: 8px;
            font-size: 12px;
            line-height: 1.4;
            max-height: 250px;
            overflow-y: auto;
            display: none;
        }

        #remainingQueries {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }

        /* Modal styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgb(0,0,0); 
            background-color: rgba(0,0,0,0.4); 
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        #chartContainer {
            height: 400px;
            margin-top: 20px;
        }

        #chartControls {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f8f9fa;
        }

        #chartControls div {
            margin-bottom: 10px;
        }

        #chartControls label {
            display: inline-block;
            width: 100px;
        }

        #chartControls select, #chartControls input[type="text"] {
            width: 200px;
            padding: 5px;
        }

        #chartControls button {
            margin-right: 10px;
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        #chartControls button:hover {
            background-color: #45a049;
        }

        #visualizationSection {
            margin-top: 20px;
        }

        #chartControls * {
            font-size: 0.9em;
        }

        #chartControls h4 {
    margin-top: 0; /* Remove top margin */
}

        #chartContainer h4 {
    margin-top: 0; /* Remove top margin */
    margin-bottom: 0;
}

    #templateCategories, #queryList {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 8px;
        margin-top: 10px;
    }

    .category-item, .query-item {
        cursor: pointer;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 12px;
        line-height: 1.3;
        transition: background-color 0.3s ease;
    }

    .category-item:hover, .query-item:hover {
        background-color: #f0f0f0;
    }

    .back-arrow {
        cursor: pointer;
        margin-right: 10px;
        display: none;
    }

    .back-arrow:hover svg {
        stroke: #007bff;
    }

    .back-arrow:hover {
        stroke: #007bff;
    }

        .template-header {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
    }

    </style>
    <!-- Include Mermaid.js from CDN -->
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        window.mermaid = mermaid;
    </script>
</head>
<body>
    <header>
        <h1>Sales Reporting System</h1>
    </header>
    <nav>
        <ul>
            <li><a href="/">Files</a></li>
            <li><a href="/tables">Tables</a></li>
            <li><a href="/stored_procedures">Stored Procedures</a></li>
            <li><a href="/table_data">Table Data</a></li>
            <li><a href="/visualizations">Visualizations</a></li>
            <li><a href="/explore_data">QuickQueryAI</a></li>
        </ul>
    </nav>
    <div class="container">
        <h2>QuickQueryAI</h2>
        <div class="section">
            <div class="section-header">Ask Your Query</div>
        <p>
            Enter your question about the sales data in the input field below, or choose one of the query templates as an example. 
            Our AI will convert your natural language query into SQL and fetch the results for you.
            <a href="#" id="dataModelLink" style="font-size: 0.8em">[View Data Model]</a>
        </p> 
            <div id="remainingQueries"></div>
            <!-- Query Templates Section -->
        <div id="queryTemplates" class="section">
            <div class="template-header">
                <svg class="back-arrow" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="19" y1="12" x2="5" y2="12"></line>
                    <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
                <h3>Query Templates</h3>
            </div>
            <div id="templateCategories"></div>
            <div id="templateQueries" style="display: none;">
                <div id="queryList"></div>
            </div>
        </div>
            <br>
            <div class="form-group">
                <input type="text" id="queryInput" class="form-control" placeholder="Enter your query here...">
                <svg id="submitQueryBtn" class="submit-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
            </div>
            <div id="queryDetails" style="display: none;">
                <div class="collapsible-header">Show SQL Query Generated</div>
                <pre><code id="sqlQueryCode"></code></pre>
            </div>
        </div>

        <!-- Query Results Section -->
        <div id="queryResultsSection" class="section" style="display: none;">
            <div class="results-header">
    <div class="section-header">Results</div>
    <div class="export-buttons">
        <button type="button" onclick="toggleVisualization()" class="export-btn" id="visualizeBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="3" y1="9" x2="21" y2="9"></line>
                <line x1="9" y1="21" x2="9" y2="9"></line>
            </svg>
            Visualization
        </button>
        <button type="button" onclick="exportResults('csv')" class="export-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            CSV
        </button>
        <button type="button" onclick="exportResults('excel')" class="export-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Excel
        </button>
    </div>
</div>
            <div class="overflow-container">
                <div id="queryResultsContainer">
                    <!-- Query results will be displayed here -->
                </div>
            </div>
            <div id="paginationControls" class="pagination">
                <button id="prevPage" onclick="changePage(-1)">Previous</button>
                <span id="pageInfo"></span>
                <button id="nextPage" onclick="changePage(1)">Next</button>
            </div>
        </div>

                <!-- Visualization Section -->
        <div id="visualizationSection" class="section" style="display: none;">
            <div class="section-header">Visualization</div>
            <div id="chartControls">
                <h4>Chart Controls</h4>
                <div>
                    <label for="chartType">Chart Type:</label>
                    <select id="chartType">
                        <option value="bar">Bar Chart</option>
                        <option value="line">Line Chart</option>
                        <option value="pie">Pie Chart</option>
                        <option value="doughnut">Doughnut Chart</option>
                        <option value="scatter">Scatter Plot</option>
                    </select>
                </div>
                <div>
                    <label for="xAxis">X-Axis:</label>
                    <select id="xAxis"></select>
                </div>
                <div>
                    <label for="yAxis">Y-Axis:</label>
                    <select id="yAxis"></select>
                </div>
                <div>
                    <label for="colorScheme">Color Scheme:</label>
                    <select id="colorScheme">
                        <option value="default">Default</option>
                        <option value="pastel">Pastel</option>
                        <option value="bright">Bright</option>
                        <option value="dark">Dark</option>
                    </select>
                </div>
                <div>
                    <label for="chartTitle">Chart Title:</label>
                    <input type="text" id="chartTitle">
                </div>
                <div>
                    <label for="xAxisLabel">X-Axis Label:</label>
                    <input type="text" id="xAxisLabel">
                </div>
                <div>
                    <label for="yAxisLabel">Y-Axis Label:</label>
                    <input type="text" id="yAxisLabel">
                </div>
                <button id="updateChart">Update Chart</button>
                <button id="exportChart">Export Chart</button>
            </div>
            <div id="chartContainer">
                <canvas id="resultChart"></canvas>
            </div>
        </div>

        <!-- Query History Section -->
        <div class="section">
            <div class="query-history-header">
                <div class="section-header">Query History</div>
                <button id="clearHistoryBtn" class="clear-history-btn" title="Clear History">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M3 6v18h18v-18h-18zm5 14c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm5 0c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm5 0c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm4-18v2h-20v-2h5.711c.9 0 1.631-1.099 1.631-2h5.315c0 .901.73 2 1.631 2h5.712z"/>
                    </svg>
                </button>
            </div>
            <div id="historyList"></div>
        </div>
    </div>

    <!-- The Modal -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="modal-mermaid-container">
                <pre class="mermaid" id="modal-mermaid">
erDiagram
    TRANSACTIONS ||--o{ PRODUCTS : contains
    TRANSACTIONS ||--|| CUSTOMERS : involves
    TRANSACTIONS ||--|| EMPLOYEES : processed_by
    TRANSACTIONS ||--|| PAYMENTS : uses
    TRANSACTIONS {
        int transaction_id PK
        datetime timestamp
        int customer_id FK
        int product_id FK
        int employee_id FK
        int payment_id FK
        int quantity
        decimal total_amount
    }
    PRODUCTS {
        int product_id PK
        string product_name
        string product_category
        decimal unit_price
    }
    PAYMENTS {
        int payment_id PK
        string payment_type
    }
    EMPLOYEES {
        int employee_id PK
        string employee_name
        string employee_ssn
        string employee_phone
        string employee_state
        string employee_city
        string employee_postal
    }
    CUSTOMERS {
        int customer_id PK
        string customer_first_name
        string customer_last_name
        string customer_city
        string customer_state
        string customer_postal
        string customer_email
        string customer_phone
    }
                </pre>
            </div>
        </div>
    </div>

    <script>

        function toggleVisualization() {
    const visualizationSection = document.getElementById('visualizationSection');
    const visualizeBtn = document.getElementById('visualizeBtn');
    if (visualizationSection.style.display === 'none') {
        visualizationSection.style.display = 'block';
        visualizeBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
            Hide Visualization
        `;
    } else {
        visualizationSection.style.display = 'none';
        visualizeBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="20" x2="18" y2="10"></line>
                <line x1="12" y1="20" x2="12" y2="4"></line>
                <line x1="6" y1="20" x2="6" y2="14"></line>
                <line x1="3" y1="20" x2="21" y2="20"></line>
            </svg>
            Visualization
        `;
    }
}

        const colorSchemes = {
            default: ['#4e79a7', '#f28e2c', '#e15759', '#76b7b2', '#59a14f', '#edc949', '#af7aa1', '#ff9da7', '#9c755f', '#bab0ab'],
            pastel: ['#fd7f6f', '#7eb0d5', '#b2e061', '#bd7ebe', '#ffb55a', '#ffee65', '#beb9db', '#fdcce5', '#8bd3c7'],
            bright: ['#e6194b', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#46f0f0', '#f032e6', '#bcf60c', '#fabebe'],
            dark: ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf']
        };

        function getColors(colorScheme, count) {
            const colors = colorSchemes[colorScheme] || colorSchemes.default;
            return colors.slice(0, count);
        }

                // Add event listeners for the new controls
        document.getElementById('updateChart').addEventListener('click', updateChart);
        document.getElementById('exportChart').addEventListener('click', exportChart);

        // Initialize Mermaid
        document.addEventListener("DOMContentLoaded", function () {
            mermaid.initialize({ startOnLoad: false });
        });

        // Get the modal
        var modal = document.getElementById("myModal");

        // Get the link that opens the modal
        var link = document.getElementById("dataModelLink");

        // When the user clicks the link, open the modal 
        link.onclick = function(event) {
            event.preventDefault(); // Prevent the default link behavior
            modal.style.display = "block";
            mermaid.init(undefined, document.getElementById("modal-mermaid"));
        }

        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];

        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
            modal.style.display = "none";
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        function updateRemainingQueries() {
            fetch('/get-remaining-queries')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('remainingQueries').textContent = `Remaining queries today: ${data.remaining}`;
                });
        }

        let queryHistory = [];
        let currentPage = 1;
        const resultsPerPage = 10;
        let allResults = [];

        document.querySelector('#queryDetails .collapsible-header').addEventListener('click', function() {
            this.classList.toggle('active');
            const content = this.nextElementSibling;
            if (content.style.display === 'block') {
                content.style.display = 'none';
                this.textContent = 'Show SQL Query Generated';
            } else {
                content.style.display = 'block';
                this.textContent = 'Hide SQL Query Generated';
            }
        });

        document.getElementById('submitQueryBtn').addEventListener('click', function() {
            const query = document.getElementById('queryInput').value;
            if (query) {
                submitQuery(query);
            } else {
                alert('Please enter a query first.');
            }
        });

        document.getElementById('queryInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const query = this.value;
                if (query) {
                    submitQuery(query);
                } else {
                    alert('Please enter a query first.');
                }
            }
        });

        function submitQuery(query) {
            const queryDetailsDiv = document.getElementById('queryDetails');
            const collapsibleHeader = queryDetailsDiv.querySelector('.collapsible-header');
            const sqlQueryCode = document.getElementById('sqlQueryCode');
            
            // Check remaining queries first
            const remainingQueries = parseInt(document.getElementById('remainingQueries').textContent.split(': ')[1]);
        
            if (remainingQueries <= 0) {
            // Immediately show the error
            queryDetailsDiv.style.display = 'block';
            collapsibleHeader.classList.remove('loading');
            collapsibleHeader.innerHTML = 'Error';
            collapsibleHeader.style.cursor = 'pointer';
            sqlQueryCode.textContent = 'Error: Daily query limit reached. Please try again tomorrow.';
            sqlQueryCode.parentElement.style.display = 'block';
            return; // Exit the function early
        }


            // Show loading state
            queryDetailsDiv.style.display = 'block';
            collapsibleHeader.classList.add('loading');
            collapsibleHeader.innerHTML = '<div class="loading-spinner"></div>Generating SQL Query';
            collapsibleHeader.style.cursor = 'default';
            sqlQueryCode.textContent = ''; // Clear any previous SQL query
            sqlQueryCode.parentElement.style.display = 'none'; // Hide the SQL query display area

            fetch(`/submit-query`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query: query })
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 429) {
                        throw new Error('Daily query limit reached. Please try again tomorrow.');
                    }
                    throw new Error('An error occurred while processing your query.');
                }
                return response.json();
            })
            .then(data => {
                const queryResultsSection = document.getElementById('queryResultsSection');
                
                // Display the SQL query
                sqlQueryCode.textContent = data.sql_query;

                // Reset the collapsible header state
                collapsibleHeader.classList.remove('loading');
                collapsibleHeader.innerHTML = 'Show SQL Query Generated';
                collapsibleHeader.style.cursor = 'pointer';
                collapsibleHeader.classList.remove('active');
                sqlQueryCode.parentElement.style.display = 'none';

                if (data.results && data.results.length > 0) {
                    allResults = data.results;
                    currentPage = 1;
                    queryResultsSection.style.display = 'block';
                    document.getElementById('visualizationSection').style.display = 'none';
                    setVisualizeButtonInitialState();                    
                    displayResults();
                    chartData = data.results;
                    populateAxisSelects(chartData);
                    suggestAndCreateChart(chartData);
                } else {
                    queryResultsSection.style.display = 'none';
                    document.getElementById('visualizationSection').style.display = 'none';
                    document.getElementById('queryResultsContainer').innerHTML = '<p>No results found.</p>';
                }

                addToHistory(query);
                updateRemainingQueries();
            })
            .catch(error => {
                console.error('Error:', error);
                
                // Update the query details div to show the error
                collapsibleHeader.classList.remove('loading');
                collapsibleHeader.innerHTML = 'Error';
                collapsibleHeader.style.cursor = 'pointer';
                
                // Display the error message in the SQL query code area
                sqlQueryCode.textContent = 'Error: ' + error.message;
                sqlQueryCode.parentElement.style.display = 'block';
                
                // Hide the query results section
                document.getElementById('queryResultsSection').style.display = 'none';
                
                // Show an alert with the error message
                alert(error.message);
                
                updateRemainingQueries();
            });
        }
        

        updateRemainingQueries();

        function setVisualizeButtonInitialState() {
            const visualizeBtn = document.getElementById('visualizeBtn');
            visualizeBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="20" x2="18" y2="10"></line>
            <line x1="12" y1="20" x2="12" y2="4"></line>
            <line x1="6" y1="20" x2="6" y2="14"></line>
            <line x1="3" y1="20" x2="21" y2="20"></line>
        </svg>
                Visualization
            `;
        }

        function displayResults() {
            const queryResultsContainer = document.getElementById('queryResultsContainer');
            const startIndex = (currentPage - 1) * resultsPerPage;
            const endIndex = startIndex + resultsPerPage;
            const pageResults = allResults.slice(startIndex, endIndex);

            const table = createResultsTable(pageResults);

            queryResultsContainer.innerHTML = '';
            queryResultsContainer.appendChild(table);

            updatePaginationControls();
        }

        function createResultsTable(results) {
            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            Object.keys(results[0]).forEach(key => {
                const th = document.createElement('th');
                th.textContent = key;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            results.forEach(row => {
                const tr = document.createElement('tr');
                Object.values(row).forEach(value => {
                    const td = document.createElement('td');
                    td.textContent = value;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);

            return table;
        }

        function updatePaginationControls() {
            const totalPages = Math.ceil(allResults.length / resultsPerPage);
            const pageInfo = document.getElementById('pageInfo');
            const prevButton = document.getElementById('prevPage');
            const nextButton = document.getElementById('nextPage');

            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            prevButton.disabled = currentPage === 1;
            nextButton.disabled = currentPage === totalPages;
        }

        function changePage(direction) {
            currentPage += direction;
            displayResults();
        }

        function exportResults(format) {
            fetch(`/export-query-results`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ data: allResults, format: format })
            })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = format === 'csv' ? 'query_results.csv' : 'query_results.xlsx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function addToHistory(query) {
            queryHistory.unshift(query);
            //if (queryHistory.length > 10) {
            //    queryHistory.pop();
            //}
            updateHistoryDisplay();

            fetch('/save-query-history', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ history: queryHistory })
            });
        }

        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            queryHistory.forEach((query, index) => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.textContent = `${index + 1}. ${query.substring(0, 60)}${query.length > 60 ? '...' : ''}`;
                item.onclick = () => {
                    document.getElementById('queryInput').value = query;
                };
                historyList.appendChild(item);
            });
        }

        function clearHistory() {
            queryHistory = [];
            updateHistoryDisplay();
            
            fetch('/clear-query-history', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
        }

        document.getElementById('clearHistoryBtn').addEventListener('click', clearHistory);

        fetch('/get-query-history')
            .then(response => response.json())
            .then(data => {
                queryHistory = data.history;
                updateHistoryDisplay();
            });

        const queryTemplates = [
            {
                category: "Sales Analysis",
                queries: [
                    "What is the total sales amount for each product?",
                    "Show the monthly sales trend over the last year.",
                    "Which are the top 5 best-selling products by quantity?",
                    "What is the average transaction amount for each product category?",
                    "How do sales vary by day of the week?",
                    "What is the year-over-year growth in sales for each product category?"
                ]
            },
            {
                category: "Customer Insights",
                queries: [
                    "Who are the top 10 customers by total purchase amount?",
                    "What is the average purchase frequency for our customers?",
                    "How many customers have not made a single transaction in the last 6 months?",
                    "What is the distribution of customers across different states?",
                    "Who are the customers that have purchased products from all categories?",
                    "What is the average customer lifetime value?"
                ]
            },
            {
                category: "Product Performance",
                queries: [
                    "What is the average quantity per order for each product?",
                    "How does product performance vary across different states?",
                    "Which products have shown the most growth in sales over the past year?",
                    "What is the seasonal trend for each product category?",
                    "Which products are underperforming compared to the average in their category?",
                    "What is the average sales per day for each product?"
                ]
            },
            {
                category: "Employee Performance",
                queries: [
                    "Who are the top 5 employees by total sales amount?",
                    "What is the average transaction value for each employee?",
                    "How does employee performance vary by region?",
                    "What is the average number of transactions per day for each employee?",
                    "What is the trend of each employee's sales performance over the past year?",
                    "Which employees have the highest number of transactions?"
                ]
            },
            {
                category: "Payment and Pricing Analysis",
                queries: [
                    "What are the most commonly used payment methods?",
                    "How does the average transaction amount vary by payment method?",
                    "What is the distribution of transaction amounts across different price ranges?",
                    "Which payment methods are preferred for high-value transactions?",
                    "How has the usage of different payment methods changed over time?",
                    "What is the average transaction amount for each payment method by state?"
                ]
            },
            {
                category: "Geographic and Temporal Patterns",
                queries: [
                    "What is the total sales amount for each state?",
                    "How do sales patterns differ between weekdays and weekends?",
                    "Which cities have shown the highest growth in sales over the past year?",
                    "What are the peak hours for transactions in different regions?",
                    "How does the product category preference vary by state?",
                    "What is the average transaction amount for each state?"
                ]
            }
        ];

        function populateQueryTemplates() {
            const templateCategories = document.getElementById('templateCategories');
            templateCategories.innerHTML = '';
            queryTemplates.forEach((category, index) => {
                const item = document.createElement('div');
                item.className = 'category-item';
                item.textContent = category.category;
                item.onclick = () => showQueries(index);
                templateCategories.appendChild(item);
            });
        }

        function showQueries(categoryIndex) {
            const templateCategories = document.getElementById('templateCategories');
            const templateQueries = document.getElementById('templateQueries');
            const queryList = document.getElementById('queryList');
            const backArrow = document.querySelector('.back-arrow');

            templateCategories.style.display = 'none';
            templateQueries.style.display = 'block';
            backArrow.style.display = 'inline-block';

            queryList.innerHTML = '';
            queryTemplates[categoryIndex].queries.forEach(query => {
                const item = document.createElement('div');
                item.className = 'query-item';
                item.textContent = query;
                item.onclick = () => {
                    document.getElementById('queryInput').value = query;
                };
                queryList.appendChild(item);
            });
        }

        document.querySelector('.back-arrow').addEventListener('click', () => {
        document.getElementById('templateCategories').style.display = 'grid';
        document.getElementById('templateQueries').style.display = 'none';
        document.querySelector('.back-arrow').style.display = 'none';
        });

        populateQueryTemplates();

        let currentChart = null;

        function suggestAndCreateChart(data) {
            fetch('/suggest-chart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ data: data })
            })
            .then(response => response.json())
            .then(suggestion => {
                document.getElementById('chartType').value = suggestion.chartType;
                updateChart();
            });
        }

        let chartData = null;

        function populateAxisSelects(data) {
            const xAxisSelect = document.getElementById('xAxis');
            const yAxisSelect = document.getElementById('yAxis');
            const columns = Object.keys(data[0]);
            
            xAxisSelect.innerHTML = '';
            yAxisSelect.innerHTML = '';
            
            columns.forEach(column => {
                xAxisSelect.add(new Option(column, column));
                yAxisSelect.add(new Option(column, column));
            });
            
            // Default Y-axis to the second column if it exists
            if (columns.length > 1) {
                yAxisSelect.value = columns[1];
            }
        }

        function updateChart() {
            const chartType = document.getElementById('chartType').value;
            const xAxis = document.getElementById('xAxis').value;
            const yAxis = document.getElementById('yAxis').value;
            const chartTitle = document.getElementById('chartTitle').value;
            const xAxisLabel = document.getElementById('xAxisLabel').value;
            const yAxisLabel = document.getElementById('yAxisLabel').value;
            const colorScheme = document.getElementById('colorScheme').value;
            
            createChart(chartData, chartType, xAxis, yAxis, chartTitle, xAxisLabel, yAxisLabel, colorScheme);
        }

        function createChart(data, chartType, xAxis, yAxis, chartTitle, xAxisLabel, yAxisLabel, colorScheme) {
            const ctx = document.getElementById('resultChart').getContext('2d');
            const chartContainer = document.getElementById('chartContainer');
    
            if (!data || data.length === 0) {
                chartContainer.style.display = 'none';
                return;
            }
            if (currentChart) {
                currentChart.destroy();
            }
    
            chartContainer.style.display = 'block';
            
            const labels = data.map(item => item[xAxis]);
            let datasets;

            // Set default chart title based on chart type and axes
            let defaultTitle;
            if (chartType === 'pie' || chartType === 'doughnut') {
                defaultTitle = `Distribution of ${yAxis} by ${xAxis}`;
            } else {
                defaultTitle = `${yAxis} vs ${xAxis}`;
            }
    
            // Use the provided chartTitle if it's not empty, otherwise use the default title
            const finalChartTitle = chartTitle || defaultTitle;

            if (chartType === 'pie' || chartType === 'doughnut') {
                datasets = [{
                    data: data.map(item => item[yAxis]),
                    backgroundColor: getColors(colorScheme, data.length),
                    label: yAxis
                }];
            } else {
                datasets = [{
                    label: yAxis,
                    data: data.map(item => item[yAxis]),
                    backgroundColor: getColors(colorScheme, 1)[0],
                    borderColor: getColors(colorScheme, 1)[0],
                    fill: false
                }];
            }

    const options = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            title: {
                display: true,
                text: finalChartTitle
            },
            legend: {
                display: chartType === 'pie' || chartType === 'doughnut',
                position: 'top',
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        let label = context.label || '';
                        if (label) {
                            label += ': ';
                        }
                        if (context.parsed !== null) {
                            label += context.parsed;
                            if (chartType === 'pie' || chartType === 'doughnut') {
                                label += ` ${yAxis}`;
                            }
                        }
                        return label;
                    }
                }
            }
        },
        scales: {
            x: {
                display: chartType !== 'pie' && chartType !== 'doughnut',
                title: {
                    display: chartType !== 'pie' && chartType !== 'doughnut',
                    text: xAxisLabel || xAxis
                }
            },
            y: {
                display: chartType !== 'pie' && chartType !== 'doughnut',
                title: {
                    display: chartType !== 'pie' && chartType !== 'doughnut',
                    text: yAxisLabel || yAxis
                },
                beginAtZero: true
            }
        }
    };

    if (chartType === 'pie' || chartType === 'doughnut') {
        options.plugins.subtitle = {
            display: true,
            text: `Values represent: ${yAxis}`,
            position: 'bottom'
        };
    }

    if (chartType === 'scatter') {
        options.scales.x.type = 'linear';
        options.scales.y.type = 'linear';
        datasets[0].pointBackgroundColor = datasets[0].backgroundColor;
        delete datasets[0].backgroundColor;
        delete datasets[0].borderColor;
    }

    currentChart = new Chart(ctx, {
        type: chartType,
        data: {
            labels: labels,
            datasets: datasets
        },
        options: options
    });
}

        function exportChart() {
            const link = document.createElement('a');
            link.download = 'chart.png';
            link.href = document.getElementById('resultChart').toDataURL();
            link.click();
        }
        setVisualizeButtonInitialState();
    </script>
</body>
</html>