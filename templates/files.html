<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Reporting System - Upload Files</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/shared-styles.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        .modal {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
}

.modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 800px;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover,
.close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}

.file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.preview-btn {
    background-color: #4CAF50;
    border: none;
    color: white;
    padding: 5px 10px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 14px;
    margin: 4px 2px;
    cursor: pointer;
    border-radius: 4px;
}
    </style>
</head>
<body>
    <div>
        <h1>Sales Reporting System</h1>
    </div>

    <nav>
        <div id="mobile-menu" class="menu-toggle">
            <span class="bar"></span>
            <span class="bar"></span>
            <span class="bar"></span>
        </div>
        <ul class="nav-list">
            <li><a href="/">Home</a></li>
            <li><a href="/files">Upload Files</a></li>
            <li><a href="/table_data">Data Preview</a></li>
            <li><a href="/visualizations">BI Dashboards</a></li>
            <li><a href="/explore_data">QuickQueryAI</a></li>
            <li><a href="/admin">Admin</a></li>
        </ul>
    </nav>

    <div class="container">
        <h2>Files</h2>

        <div class="section">
            <div class="section-header">List and Delete Old Uploaded Files</div>
            <p>Review and manage previously uploaded files. Use the list to check existing files and use the delete button to clear all files if needed.</p>
            <button id="listBlobsBtn">List Current Files</button>
            <div id="blobsList" class="blob-list">No files listed</div>
            <button id="deleteBlobsBtn" class="delete-btn">Delete All Files</button>
        </div>

        <div class="section">
            <div class="section-header">Upload New Files</div>
            <p>Please select the dimension and fact table files to upload. You can drag and drop files into the area below or click to browse your files.</p>
            <div id="dragWrapper" class="drag-area">
                Drag and drop files here or click to browse
            </div>
            <div id="fileList">No files selected</div>
            <div class="form-group">
                <input type="file" id="fileInput" multiple style="display: none;">
                <button id="uploadBtn">Upload Files</button>
            </div>
        </div>

        <div id="previewModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">File Preview</h2>
                    <span class="close">&times;</span>
                </div>
                <div id="previewContent"></div>
            </div>
        </div>
    </div>
    <script>
// File preview functionality
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const modal = document.getElementById('previewModal');
    const closeBtn = modal.querySelector('.close');
    const previewContent = document.getElementById('previewContent');
    const dragWrapper = document.getElementById('dragWrapper');

    // File input change event
    fileInput.addEventListener('change', handleFileSelection);

    // Drag and drop events
    dragWrapper.addEventListener('dragover', (e) => {
        e.preventDefault();
        dragWrapper.classList.add('highlight');
    });

    dragWrapper.addEventListener('dragleave', () => {
        dragWrapper.classList.remove('highlight');
    });

    dragWrapper.addEventListener('drop', (e) => {
        e.preventDefault();
        dragWrapper.classList.remove('highlight');
        handleFileSelection({ target: { files: e.dataTransfer.files } });
    });

    // Click to browse
    dragWrapper.addEventListener('click', () => {
        fileInput.click();
    });

    // Preview button click event
    fileList.addEventListener('click', function(e) {
        if (e.target.classList.contains('preview-btn')) {
            const fileName = e.target.getAttribute('data-file');
            const file = Array.from(fileInput.files).find(f => f.name === fileName);
            if (file) {
                previewFile(file);
            }
        }
    });

    // Close modal events
    closeBtn.onclick = function() {
        modal.style.display = "none";
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    function handleFileSelection(e) {
        fileList.innerHTML = '';
        for (let file of e.target.files) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <span>${file.name}</span>
                <button class="preview-btn" data-file="${file.name}">Preview</button>
            `;
            fileList.appendChild(fileItem);
        }
    }

    function previewFile(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const html = XLSX.utils.sheet_to_html(worksheet);
            previewContent.innerHTML = html;
            modal.style.display = "block";
        };
        reader.readAsArrayBuffer(file);
    }
});
    </script>
</body>
</html>
